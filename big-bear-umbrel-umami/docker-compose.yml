# Name of the application
# List of services that this application uses
services:
  # Main service for the Umami application
  app:
    image: ghcr.io/umami-software/umami:postgresql-latest # Docker image for the Umami app
    ports:
      - "3000:3000" # Port mapping: host:container
    environment: # Environment variables for the service
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: replace-me-with-a-random-string
    depends_on: # Dependency of this service
      db:
        condition: service_healthy
    restart: always # Restart policy
  # Database service for the Umami application
  db:
    image: postgres:15-alpine # Docker image for the PostgreSQL database
    environment: # Environment variables for the service
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    volumes: # Volumes for data persistence
      - ${APP_DATA_DIR}/pgdata:/var/lib/postgresql/data
    restart: always # Restart policy
    healthcheck: # Health check configuration
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
  app_proxy:
    environment:
      APP_HOST: big-bear-umbrel-umami_app_1
      APP_PORT: "3022"

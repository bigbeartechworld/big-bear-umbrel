# Configuration for libredesk setup
# Name of the big-bear-libredesk application
version: "3.7"
# Service definitions for the big-bear-libredesk application
services:
  app_proxy:
    environment:
      APP_HOST: _big-bear-libredesk_1
      APP_PORT: "9000"
  # Service name: big-bear-libredesk
  # The `big-bear-libredesk` service definition
  big-bear-libredesk:
    # Image to be used for the container
    image: libredesk/libredesk:v0.7.4-alpha
    # Container restart policy
    restart: unless-stopped
    # Environment variables
    environment:
      - LIBREDESK_SYSTEM_USER_PASSWORD="c6b51a4e-ab9d-4f4f-933e-e96ed3570c1A"
    # Volumes to be mounted to the container
    volumes:
      # Mounting the local libredesk/uploads directory to /libredesk/uploads inside the container
      - ${APP_DATA_DIR}/libredesk_uploads:/libredesk/uploads:rw
      # Mounting the local libredesk/config.toml directory to /libredesk/config.toml inside the container
      - ${APP_DATA_DIR}/libredesk_config:/libredesk/config:rw
    command: [sh, -c, "./libredesk --install --idempotent-install --yes --config /libredesk/config/config.toml && ./libredesk --upgrade --yes --config /libredesk/config/config.toml && ./libredesk --config /libredesk/config/config.toml"]
    # Dependencies
    depends_on:
      - big-bear-libredesk-db
      - big-bear-libredesk-redis
    # Networks
    networks:
      - big-bear-libredesk-network
  # PostgreSQL database
  big-bear-libredesk-db:
    image: postgres:17-alpine
    restart: unless-stopped
    networks:
      - big-bear-libredesk-network
    environment:
      # Set these environment variables to configure the database, defaults to libredesk.
      POSTGRES_USER: libredesk
      POSTGRES_PASSWORD: libredesk
      POSTGRES_DB: big_bear_libredesk
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U libredesk"]
      interval: 10s
      timeout: 5s
      retries: 6
    volumes:
      - ${APP_DATA_DIR}/libredesk_data_postgres:/var/lib/postgresql/data
  # Redis
  big-bear-libredesk-redis:
    image: redis:7.4.6-alpine@sha256:7a7c6b5c49a6896d0a58ee0c6dc0dcabe14f30f0a2f7d2d1362d276fa2d43166
    restart: unless-stopped
    networks:
      - big-bear-libredesk-network
    volumes:
      - ${APP_DATA_DIR}/libredesk_data_redis:/data
networks:
  big-bear-libredesk-network:
    driver: bridge
